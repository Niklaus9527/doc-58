# 成长体系权益模块文档

## 1. 背景

> 成长体系中，用户通过完成任务，获得成长值、权益和现金奖励。
>
> 其中权益有部落内部的权益，如现金奖励等；也有一些外部权益，例如家政优惠券、招聘VIP、保险保单等。
>
> 外部权益需对接多个业务方，并对内部提供统一的服务。为了统一权益结构，方便后续扩展。



## 2. 架构图

> 本项目由权益路由和权益系统构成。
>
> 权益路由对接各个业务方，将各业务方权益封装成统一的实体，统一进行分发；查询、领取权益都通过权益路由完成。
>
> 权益系统根据业务方需要，调用权益路由进行查询或者领取操作，并对成长体系提供查询、领取等接口。

![成长体系权益架构图](/Users/zhangyayun/Documents/成长体系权益架构图.svg)



## 3. 时序图

- #### 成长体系权益

成长体系权益通过不同场景调用权益路由来查询、领取各种权益，根据场景的不同，返回相应的权益信息（见：成长体系外部权益时序图）

用户访问权益功能时共有三种场景：

1. 用户在成长体系首页、成长体系权益列表页查询权益列表；
2. 用户在权益详情页查询权益详情；
3. 用户在权益详情页领取权益。

```mermaid
sequenceDiagram
    title:成长体系外部权益时序图
    participant user as 用户
    participant wptgrowing as 成长体系
    participant GrowingRightsService as 成长体系权益
    participant UserGrowingLevelService as 成长体系等级
    participant EquityRouterService as 权益路由
    
    note left of user : 成长体系首页/权益列表页
    user ->> + wptgrowing : 查询权益列表<br/>（首页/权益列表页）
    wptgrowing ->> + GrowingRightsService : 查询外部权益列表<br/>queryAllLevelGrowingRights
    GrowingRightsService ->> + UserGrowingLevelService : 查询用户等级<br/>getUserLevel
    UserGrowingLevelService -->> - GrowingRightsService : 返回用户等级<br/>UserLevel
    GrowingRightsService ->> + EquityRouterService : 并行查询业务方权益
    par 黄页
    	GrowingRightsService ->> EquityRouterService : 查询黄页权益
    and 保险
    	GrowingRightsService ->> EquityRouterService : 查询保险权益
    and 招聘
    	GrowingRightsService ->> EquityRouterService : 查询招聘权益
    end
    EquityRouterService -->> - GrowingRightsService : 返回各业务方权益
    opt 首页
        GrowingRightsService ->> GrowingRightsService : 筛选当前等级权益
    end
    GrowingRightsService ->> GrowingRightsService : 封装权益等级信息<br/>GrowingLevelInfo
    GrowingRightsService -->> - wptgrowing : 返回外部权益列表<br/>Map<Integer,<br/>List<GrowingLevelInfo>>
    wptgrowing -->> - user : 返回用户权益列表<br/>（当前等级/所有等级）
    
    note left of user : 权益详情页
    user ->> + wptgrowing : 查询权益详情
    wptgrowing ->> + GrowingRightsService : 查询外部权益详情<br/>queryGrowingRights   
    GrowingRightsService ->> + UserGrowingLevelService : 查询用户等级<br/>getUserLevel
    UserGrowingLevelService -->> - GrowingRightsService : 返回用户等级<br/>UserLevel
    GrowingRightsService ->> + EquityRouterService : 根据业务方查询权益
    alt 黄页
    	GrowingRightsService ->> EquityRouterService : 查询黄页权益
    else 保险
    	GrowingRightsService ->> EquityRouterService : 查询保险权益
    else 招聘
    	GrowingRightsService ->> EquityRouterService : 查询招聘权益
    end
    EquityRouterService -->> - GrowingRightsService : 返回业务方权益
    GrowingRightsService ->> GrowingRightsService : 封装权益等级信息<br/>GrowingLevelInfo
    GrowingRightsService -->> - wptgrowing : 返回外部权益详情<br/>GrowingQueryDTO
    wptgrowing -->> - user : 返回权益详情
    
    note left of user : 领取权益
    user ->> + wptgrowing : 领取权益
    wptgrowing ->> + GrowingRightsService : 领取外部权益<br/>receiveGrowingRights
    GrowingRightsService ->> + UserGrowingLevelService : 查询用户等级<br/>getUserLevel
    UserGrowingLevelService -->> - GrowingRightsService : 返回用户等级<br/>UserLevel
    GrowingRightsService ->> + EquityRouterService : 根据业务方领取权益
    alt 黄页
    	GrowingRightsService ->> EquityRouterService : 领取黄页权益
    else 保险
    	GrowingRightsService ->> EquityRouterService : 领取保险权益
    else 招聘
    	GrowingRightsService ->> EquityRouterService : 领取招聘权益
    end
    EquityRouterService -->> - GrowingRightsService : 返回权益领取结果
    GrowingRightsService ->> GrowingRightsService : 封装领取结果<br/>GrowingReceiveDTO
    GrowingRightsService -->> - wptgrowing : 返回外部权益领取结果<br/>GrowingReceiveDTO
    wptgrowing -->> - user : 返回权益领取结果
```

- #### 权益路由

权益路由模块对接各个权益业务方，对内调用各个业务方接口，并将各个业务方权益信息转化为统一的权益实体，为后续接入其他业务方提供方便；对外提供统一的权益结构、入参、出参，使得调用方使用更简单、高效。（见：权益路由时序图）

目前各业务方如下：

1. 黄页：提供到家精选优惠券相关权益信息，涉及查询优惠券信息、领取状态、已领优惠券、领取优惠券等接口。
2. 招聘：提供招聘VIP相关权益信息，涉及查询领取状态、领取权益等接口。
3. 保险：提供保险保单相关权益信息，涉及领取状态等接口。


```mermaid
sequenceDiagram
    title:权益路由时序图
    participant GrowingRightsService as 成长体系权益
    participant EquityRouterService as 权益路由
    participant bxorderservice as 保险服务
    participant cvip as 招聘服务
    participant lbgunionbusiness as 黄页服务
    
    note over bxorderservice,lbgunionbusiness : 外部权益
    note left of GrowingRightsService : 查询权益
    GrowingRightsService ->> + EquityRouterService : 查询用户权益<br/>getGrowingQueryDTO
    note left of EquityRouterService : 根据各业务方查询权益
    alt sector=5801(黄页)
        EquityRouterService ->> EquityRouterService : 查询权益编码、文案配置
        EquityRouterService ->> + lbgunionbusiness : 批量查询优惠券信息<br/>queryCodeFull
        lbgunionbusiness -->> - EquityRouterService : 返回优惠券信息<br/>CouponQueryResult
        EquityRouterService ->> + lbgunionbusiness : 批量查询可领取优惠券<br/>queryCanGet
        lbgunionbusiness -->> - EquityRouterService : 返回优惠券能否领取信息<br/>CouponCanGetQueryResult
        opt 不存在可领取优惠券
            EquityRouterService ->> + lbgunionbusiness : 批量查询已领取优惠券<br/>queryUserCouponAvailable
            lbgunionbusiness -->> - EquityRouterService : 返回已领取优惠券信息<br/>CouponUserQueryResult
        end
    else sector=5802(招聘)
        EquityRouterService ->> EquityRouterService : 查询权益编码、详情、文案配置
        EquityRouterService ->> + cvip : 查询是否可领取招聘C端VIP权益<br/>checkBeforeSend
        cvip -->> - EquityRouterService : 返回是否可领取
    else sector=5803(保险)
        EquityRouterService ->> EquityRouterService : 查询权益编码、文案配置
        EquityRouterService ->> + bxorderservice : 查询用户领取状态<br/>getFreeInsuranceInfo
        bxorderservice -->> - EquityRouterService : 返回领取状态FreeInsuranceDTO
    end
    EquityRouterService ->> EquityRouterService : 封装权益详情<br/>GrowingQueryDTO
    EquityRouterService -->> - GrowingRightsService : 返回权益详情<br/>GrowingQueryDTO

    note left of GrowingRightsService : 领取权益
    GrowingRightsService ->> + EquityRouterService : 领取用户权益<br/>receiveGrowingRights
    note left of EquityRouterService : 根据业务方领取权益
    alt sector=5801(黄页)
        EquityRouterService ->> EquityRouterService : 查询权益编码、文案配置<br/>筛选当前等级权益
        EquityRouterService ->> + lbgunionbusiness : 批量查询可领取优惠券<br/>queryCanGet
        lbgunionbusiness -->> - EquityRouterService : 返回优惠券能否领取信息<br/>CouponCanGetQueryResult
        opt 存在可领取优惠券
            EquityRouterService ->> + lbgunionbusiness : 批量领取优惠券<br/>batchGetCoupon
            lbgunionbusiness -->> - EquityRouterService : 返回批量领取结果<br/>CouponBatchGetResult
        end
    else sector=5802(招聘)
        EquityRouterService ->> + cvip : 查询用户领取状态<br/>getFreeInsuranceInfo
        cvip -->> - EquityRouterService : 返回领取状态FreeInsuranceDTO
        opt 未领取过C端VIP权益
            EquityRouterService ->> + cvip : 领取C端VIP权益<br/>grantCVipByActivityId
            cvip -->> - EquityRouterService : 返回领取结果
        end
    else sector=5803(保险)
        EquityRouterService ->> + bxorderservice : 跳转保险页面，保险业务方处
    end
    EquityRouterService ->> EquityRouterService : 封装权益领取结果<br/>GrowingReceiveDTO
    EquityRouterService -->> - GrowingRightsService : 返回权益领取结果<br/>GrowingReceiveDTO

    
```

## 4. 功能模块设计方案



- 成长体系外部权益服务GrowingRightsService，包括查询权益详情、领取权益、查询权益列表接口

```java
/**
 * 成长体系权益服务
 */
@ServiceContract
public interface IGrowingRightsService {
    IGrowingRightsService PROXY = ProxyFactory.create(IGrowingRightsService.class, "tcp://equitymesh/GrowingRightsService");

    /**
     * 查询成长体系用户权益
     *
     * @param userId  用户uid
     * @param levelId 等级ID，暂时不使用
     * @param sector  权益方 {@link com.bj58.social.equitymesh.enums.SectorEnum}
     * @return GrowingQueryDTO 权益详情 {@link GrowingQueryDTO}
     * @throws Exception
     */
    @OperationContract
    GrowingQueryDTO queryGrowingRights(long userId, long levelId, int sector) throws Exception;

    /**
     * 领取成长体系用户权益
     *
     * @param userId  用户uid
     * @param levelId 等级ID，暂时不使用
     * @param sector  权益方 {@link com.bj58.social.equitymesh.enums.SectorEnum}
     * @return GrowingReceiveDTO 权益领取结果 {@link GrowingReceiveDTO}
     * @throws Exception
     */
    @OperationContract
    GrowingReceiveDTO receiveGrowingRights(long userId, long levelId, int sector) throws Exception;

    /**
     * 查询用户当前等级权益列表
     * @param userId
     * @return Map<Integer, List<GrowingLevelInfo>> 等级权益 {@link GrowingLevelInfo}
     * @throws Exception
     */
    @OperationContract
    Map<Integer, List<GrowingLevelInfo>> queryAllLevelGrowingRights(long userId) throws Exception;
}
```



- 权益路由服务EquityRouterService，包括查询权益信息、用户已有权益、是否可领取权益、领取权益四个功能

```java
/**
 * 权益路由服务
 */
@ServiceContract
public interface IEquityRouterService {
    IEquityRouterService PROXY = ProxyFactory.create(IEquityRouterService.class, "tcp://equitymesh/EquityRouterService");

    /**
     * 获取权益基本信息
     *
     * @param sector
     * @param equityCode
     * @return
     * @throws Exception
     */
    @OperationContract
    EquityResult<EquityInfo> getEquity(int sector, String equityCode) throws Exception;

    /**
     * 获取用户已有权益
     *
     * @param userId
     * @param sector
     * @param equityCode
     * @return
     * @throws Exception
     */
    @OperationContract
    EquityResult<EquityUserInfo> getUserEquity(long userId, int sector, String equityCode) throws Exception;

    /**
     * 批量获取用户已有权益
     *
     * @param userId
     * @param sector
     * @param equityCodeList
     * @return
     * @throws Exception
     */
    @OperationContract
    EquityResult<List<EquityUserInfo>> batchGetUserEquity(long userId, int sector, List<String> equityCodeList) throws Exception;

    /**
     * 校验用户是否可领取权益
     *
     * @param userId
     * @param sector
     * @param equityCode
     * @return
     * @throws Exception
     */
    @OperationContract
    EquityResult<EquityCheckInfo> checkUserEquity(long userId, int sector, String equityCode) throws Exception;

    /**
     * 批量校验用户是否可领取权益
     *
     * @param userId
     * @param sector
     * @param equityCodeList
     * @return
     * @throws Exception
     */
    @OperationContract
    EquityResult<List<EquityCheckInfo>> batchCheckUserEquity(long userId, int sector, List<String> equityCodeList) throws Exception;

    /**
     * 用户领取权益
     *
     * @param userId
     * @param sector
     * @param equityCode
     * @return
     * @throws Exception
     */
    @OperationContract
    EquityResult<EquityReceiveInfo> receiveUserEquity(long userId, int sector, String equityCode) throws Exception;

    /**
     * 用户领取批量权益
     *
     * @param userId
     * @param sector
     * @param equityCodeList
     * @return
     * @throws Exception
     */
    @OperationContract
    EquityResult<List<EquityReceiveInfo>> batchReceiveUserEquity(long userId, int sector, List<String> equityCodeList) throws Exception;
}
```



权益实体

```java
/**
 * 权益实体
 */
@SCFSerializable(name = "com.bj58.social.equitymesh.entity.basic.EquityInfo")
public class EquityInfo {

    @SCFMember(orderId = 1)
    private String code;

    @SCFMember(orderId = 2)
    private String name;

    @SCFMember(orderId = 3)
    private String desc;

    @SCFMember(orderId = 4)
    private int type;

    @SCFMember(orderId = 5)
    private int totalCount;

    @SCFMember(orderId = 6)
    private int useCount;

    @SCFMember(orderId = 7)
    private String citys;

    @SCFMember(orderId = 8)
    private Date startDate;

    @SCFMember(orderId = 9)
    private Date endDate;

    @SCFMember(orderId = 10)
    private BigDecimal discountAmount;

    @SCFMember(orderId = 11)
    private int discountType;
}
```



## 5. 难点

- ##### 外部权益属于不同部门的不同产品，如家政优惠券、招聘VIP、保险保单等，如何快速接入、易扩展？



- ##### 同期产品还有部落小金库秒杀家政优惠券活动，如何做到既支持成长体系外部权益，又支持部落小金库优惠券活动？



- ##### 查询权益时，结合用户等级，直接返回权益相关信息（标题、内容、按钮等，随用户等级变化），如何处理不同等级的展示？





## 6. 优化点

- ##### 批量查询外部权益时，存在下游服务超时问题，以及下游服务升级时造成的短暂不可用问题，推进相关部门人员优化



- ##### 开发时为了易接入、易扩展，做了部分封装，封装内部代码层级较多，过度设计？





## 7. 核心代码讲解
